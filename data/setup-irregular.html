<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" href="css/simple.min.css">
    <title>Tank sensor - Setup</title>
  </head>
  <body>
    <header>
      <nav>
        <a href="/">State</a>
        <a href="/config.html">Config</a>
        <a href="/setup.html">Setup</a>
        <a href="/update">Update</a>
      </nav>
    </header>
    <main>
      <div id="beginSetup">
        <h2>Setup for irregular formed tanks</h2>
        <p>To set up the sensor, it is necessary to install it completely in the tank and connect it. 
          Please pay particular attention to the perfect tightness of the hose and that it reaches straight to the bottom of the tank. 
          Otherwise, the entire content would not be detected and the display would be incorrect.</p>
        <p>Now prepare everything for filling the tank.
          As soon as you can turn on the water tap, start the measuring process and then start filling.</p>
          <button id="btn-start">Start</button>
      </div>
      <div id="runSetup" style="display: none">
        <h2>Carrying out the measurement process</h2>
        <p>The water flow should remain as constant as possible during the entire filling process.
          This contributes to high accuracy.</p>
        <p>Once the tank is completely filled, you can complete the process.</p>
        <button id="btn-finish">Finish</button>
        <button id="btn-abort">Abort</button>
      </div>
      <div id="error" style="display: none">
        <h2>Error</h2>
        <p id="errortext">An error occured</p>
      </div>
    </main>
    <footer>
      <p>
        <a href="https://github.com/MartinVerges/rv-smart-tanksensor" target="_blank">rv-smart-tanksensor</a> (c) 2022 by Martin Verges
      </p>
    </footer>
    <script src="js/jquery-3.6.0.min.js"></script>
    <script>
      $("#btn-start").click(function() {
        $("#beginSetup, #error").hide();

        $.post("/api/setup/start", function( data ) {
          $("#runSetup").show();
        })
        .fail(function() {
          $("#beginSetup, #runSetup").hide();
          $("#errortext").text("Unfortunately it was not possible to start the setup. Please try again!");
          $("#error").show();
        });
      });

      $("#btn-finish").click(function() {
        $("#beginSetup, #error").hide();

        $.post("/api/setup/end", function( data ) {
          $(location).prop('href', '/')
        })
        .fail(function() {
          $("#beginSetup, #runSetup").hide();
          $("#errortext").text("Unfortunately, it was not possible to complete the setup successfully. Please try again!");
          $("#error").show().removeClass("visually-hidden");
        });
      });
      $("#btn-abort").click(function() {
        $("#beginSetup, #error").hide();

        $.post("/api/setup/abort", function( data ) {
          $("#errortext").text("The setup was aborted by the user.");
          $("#error").show();
          $("#beginSetup, #runSetup").hide();
        })
        .fail(function() {
          $("#beginSetup, #runSetup").hide();
          $("#errortext").text("The setup could not be terminated.");
          $("#error").show();
        });
      });

      $.get("/api/setup/status", function( state ) {
        if (state == 0 || state == "0") {
          $("#beginSetup").show();
        } else {
          $("#runSetup").show();
        }
      })

      if (!!window.EventSource) {
        var source = new EventSource('/events');

        source.addEventListener('open', function(e) {
          console.log("Events Connected");
        }, false);

        source.addEventListener('error', function(e) {
          if (e.target.readyState != EventSource.OPEN) {
            console.log("Events Disconnected");
          }
        }, false);

        source.addEventListener('setup', function(e) {
          console.log("new datapoint received");
        }, false);
        source.addEventListener('setuperror', function(e) {
          console.log("an error occured durring setup: " + e);
        }, false);
      }
    </script>
  </body>
</html>