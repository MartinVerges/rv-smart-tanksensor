<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <title>Tank sensor - Setup</title>
  </head>
  <body>
    <header class="p-3 bg-dark text-white">
      <div class="container">
        <div class="d-flex flex-wrap align-items-center justify-content-center justify-content-lg-start">
          <ul class="nav col-12 col-lg-auto me-lg-auto mb-2 justify-content-center mb-md-0">
            <li><a href="/" class="nav-link px-2 text-white">Status</a></li>
            <li><a href="/setup.html" class="nav-link px-2 text-secondary">Setup</a></li>
            <li><a href="/update" class="nav-link px-2 text-white">Update</a></li>
          </ul>
        </div>
      </div>
    </header>
    <div class="row row-cols-1 row-cols-md-2 mb-2 text-center">
      <div class="col">
        <div class="card mb-4 rounded-3 shadow-sm">
          <div class="card-header py-3">
            <h4 class="my-0 fw-normal">Uniform tanks</h4>
          </div>
          <div class="card-body">
            <a href="/setup-uniform.html"><img src="images/tank-uniform.png" alt="Uniformed tank" class="mb-3">
              <br>
              <button type="button" class="w-75 btn btn-lg btn-primary">continue</button>
            </a>
          </div>
        </div>
      </div>
      <div class="col">
        <div class="card mb-4 rounded-3 shadow-sm">
          <div class="card-header py-3">
            <h4 class="my-0 fw-normal">Irregular formed tanks</h4>
          </div>
          <div class="card-body">
            <a href="/setup-irregular.html"><img src="images/tank-irregular.png" alt="Irregular formed tank" class="mb-3">
              <br>
              <button type="button" class="w-75 btn btn-lg btn-primary">continue</button>
            </a>
          </div>
        </div>
      </div>
    </div>
    <div class="container">
      <div class="row justify-content-md-center g-5">
        <div class="col-md-7 col-lg-8">
          <form>
            <h4 class="mb-3">Configuration</h4>
            <div class="row g-3">
              <div class="col-12">
                <label for="hostname" class="form-label">Hostname</label>
                <input type="text" class="form-control" id="hostname" name="hostname" required pattern="^[a-zA-Z][a-zA-Z\d-]{1,30}[a-zA-Z\d]$" 
                  title="Enter a hostname, 3-32 characters, beginning with a letter and containing only alphanumeric
                    characters and/or a hyphen. It must end with an alphanumeric." value="">
                <div class="invalid-feedback">Please provide a valid hostname.</div>
              </div>
              <div class="col-12">
                <div class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" role="switch" id="enableWifi">
                  <label class="form-check-label" for="enableWifi">Leave WiFi on (increased power consumption)</label>
                </div>
              </div>
              <button type="button" class="btn btn-primary btn-lg px-5 me-3" id="btn-finish">Save</button>
            </div>
          </form>
        </div>
      </div>
    </div>
    <!-- Modal -->
    <div class="modal fade" id="message" tabindex="-1" aria-labelledby="messageModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="messageModalLabel">Information</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body" id="messageModalContent">
            TEST
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>
    <!-- Footer -->
    <footer class="footer mt-auto py-3 bg-light">
      <div class="container">
        <p class="text-muted" style="text-align:center">
          <a href="https://github.com/MartinVerges/rv-smart-tanksensor" target="_blank">rv-smart-tanksensor</a> (c) 2021 by Martin Verges
        </p>
      </div>
    </footer>
    <script src="js/jquery-3.6.0.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script>
      $("#btn-finish").click(function() {
        $.ajax("/api/config", {
          type : 'POST',
          data : JSON.stringify({ 
            hostname: String($("#hostname").val()),
            enableWifi: Boolean($("#enablwifi").prop('checked'))
          }),
          dataType : "json",
          contentType : 'application/json',
          success : function(data, status, jqXHR) { // success callback
            $("#message #messageModalLabel").html("Success");
            $("#message #messageModalContent").html("Configuration stored in NVS, please restart the Sensor!");
            $("#message").show();
          },
          fail : function() {
            $("#message #messageModalLabel").html("Error");
            $("#message #messageModalContent").html("Failed to write data to NVS");
            $("#message").show()
          }
        });
      });

      // initial data loading
      $.ajax("/api/config", {
          type : 'GET',
          dataType : "json",
          contentType : 'application/json',
          success : function(data, status, jqXHR) { // success callback
            for (const [key, value] of Object.entries(data)) {
              var ele = $("#"+key);
              if (ele.is("input[type=checkbox")) {
                ele.prop('checked', Boolean(value));
              } else {
                ele.val(value);
              }
            };
          },
          fail : function() {
            $("#message #messageModalLabel").html("Error");
            $("#message #messageModalContent").html("Failed to get data from NVS");
            $("#message").show()
          }
        });
    </script>
  </body>
</html>